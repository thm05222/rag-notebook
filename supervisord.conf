[supervisord]
nodaemon=true
logfile=/dev/stdout
# Note: Cannot set maxbytes for stdout/stderr (Illegal seek error)
# Docker handles log rotation via logging drivers
logfile_maxbytes=0
pidfile=/tmp/supervisord.pid

[program:api]
# 添加 keep-alive 和超時設置以支持長時間運行的請求
# --timeout-keep-alive 300: 保持連接活躍 300 秒（5 分鐘）
# --timeout-graceful-shutdown 30: 優雅關閉超時 30 秒
command=uv run uvicorn api.main:app --host 0.0.0.0 --port 5055 --timeout-keep-alive 300 --timeout-graceful-shutdown 30
stdout_logfile=/dev/stdout
# Note: Cannot set maxbytes for stdout/stderr in Docker (use Docker logging driver instead)
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
autorestart=true
priority=10
autostart=true

[program:worker]
command=uv run surreal-commands-worker --import-modules commands
stdout_logfile=/dev/stdout
# Note: Cannot set maxbytes for stdout/stderr in Docker (use Docker logging driver instead)
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
autorestart=true
priority=20
autostart=true
startsecs=3

[program:frontend]
# Next.js Frontend Startup Configuration
# 
# USE_STANDALONE 環境變數控制啟動方式：
# - true/未設置（默認）：使用 standalone 模式 (node .next/standalone/server.js)
#   這是 Next.js 推薦的 Docker 部署方式，所有功能完整支持，無警告
# - false：使用傳統方式 (npm run start)
#   僅在 standalone 模式有問題時使用作為 fallback
#
# 切換方式：
# - 使用方案 A（standalone，默認）：不設置或設置 USE_STANDALONE=true
# - 切換到方案 B（npm start）：設置 USE_STANDALONE=false
command=bash -c "sleep 5 && if [ \"${USE_STANDALONE:-true}\" != \"false\" ]; then node .next/standalone/server.js; else npm run start; fi"
directory=/app/frontend
environment=NODE_ENV="production",PORT="8188"
passenv=API_URL,NEXT_PUBLIC_API_URL,INTERNAL_API_URL,USE_STANDALONE
stdout_logfile=/dev/stdout
# Note: Cannot set maxbytes for stdout/stderr in Docker (use Docker logging driver instead)
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
autorestart=true
priority=30
autostart=true
startsecs=5
